class AIChatbot extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.isOpen=!1,this.messages=[],this.loading=!1,this.sessionId=this.generateSessionId(),this._justOpened=!1}generateSessionId(){return"sess-"+Math.random().toString(36).substr(2,10)}static get observedAttributes(){return["title","webhook","first-messages"]}attributeChangedCallback(t,e,s){e!==s&&("title"===t&&(this.title=s),"webhook"===t&&(this.webhook=s),"first-messages"===t&&(this.firstMessages=s),this.render())}connectedCallback(){this.title=this.getAttribute("title")||"AI Asistente",this.webhook=this.getAttribute("webhook")||"",this.firstMessages=this.getAttribute("first-messages")||"",this.messages=[],this.sessionId=this.generateSessionId(),this.firstMessages&&this.firstMessages.split("|").forEach(t=>{this.messages.push({from:"bot",text:t.trim()})}),this.render()}newConversation(){this.sessionId=this.generateSessionId(),this.messages=[],this.firstMessages&&this.firstMessages.split("|").forEach(t=>{this.messages.push({from:"bot",text:t.trim()})}),this.render()}toggleChat(){let t=!this.isOpen;this.isOpen=!this.isOpen,this.isOpen&&t&&(this._justOpened=!0),this.render(),this.isOpen&&setTimeout(()=>{let t=this.shadowRoot.querySelector(".chatbot-messages");t&&(t.scrollTop=t.scrollHeight)},100)}async sendMessage(t){t.preventDefault();let e=this.shadowRoot.querySelector(".chatbot-input"),s=e.value.trim();if(s){this.messages.push({from:"user",text:s}),this.loading=!1,this.render(),e.value="";try{let o=await fetch(this.webhook,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:this.sessionId,action:"sendMessage",chatInput:s})}),i=await o.json(),a=i.reply||i.message||i.output||JSON.stringify(i);this.messages.push({from:"bot",text:a})}catch(n){console.error("Error al enviar el mensaje:",n),this.messages.push({from:"bot",text:"Error de conexi\xc3\xb3n."})}this.loading=!1,this.render(),setTimeout(()=>{let t=this.shadowRoot.querySelector(".chatbot-messages");t&&(t.scrollTop=t.scrollHeight)},100)}}render(){let t=`
        .chatbot-overlay {
          display: ${this.isOpen?"block":"none"};
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(30,40,60,0.18);
          z-index: 9998;
          animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .chatbot-bubble {
          position: fixed;
          bottom: 24px;
          right: 24px;
          z-index: 9999;
          background: #fff;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          box-shadow: 0 2px 12px rgba(0,0,0,0.16);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: box-shadow 0.2s, transform 0.2s;
          ${this.isOpen?"box-shadow: 0 8px 32px rgba(45,127,249,0.25); transform: scale(1.08) rotate(-6deg); pointer-events: none;":""}
        }
        .chatbot-bubble:hover {
          box-shadow: 0 8px 32px rgba(45,127,249,0.25);
          transform: scale(1.08) rotate(-6deg);
        }
        .chatbot-window {
          position: fixed;
          bottom: 100px;
          right: 24px;
          width: 340px;
          max-width: 95vw;
          height: 480px;
          background: #fff;
          border-radius: 16px;
          box-shadow: 0 4px 32px rgba(0,0,0,0.18);
          display: flex;
          flex-direction: column;
          overflow: hidden;
          z-index: 10000;
        }
        .chatbot-window.pop {
          animation: chatbot-pop 0.2s;
        }
        @keyframes chatbot-pop {
          0% { transform: scale(0.8); opacity: 0; }
          100% { transform: scale(1); opacity: 1; }
        }
        .chatbot-header {
          background: #2d7ff9;
          color: #fff;
          padding: 16px;
          font-size: 1.1em;
          font-weight: bold;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .chatbot-close {
          background: none;
          border: none;
          color: #fff;
          font-size: 1.3em;
          cursor: pointer;
          display: flex;
          align-items: center;
        }
        .chatbot-close svg {
          width: 1.5em;
          height: 1.5em;
          display: block;
        }
        .chatbot-messages {
          flex: 1;
          padding: 16px;
          overflow-y: auto;
          background: #f7f8fa;
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        .chatbot-msg {
          max-width: 80%;
          padding: 10px 14px;
          border-radius: 16px;
          font-size: 1em;
          line-height: 1.4;
          word-break: break-word;
        }
        .chatbot-msg.bot {
          background: #e6f0ff;
          color: #1a2a3a;
          align-self: flex-start;
          border-bottom-left-radius: 4px;
        }
        .chatbot-msg.user {
          background: #2d7ff9;
          color: #fff;
          align-self: flex-end;
          border-bottom-right-radius: 4px;
        }
        .chatbot-input-area {
          display: flex;
          padding: 12px;
          background: #fff;
          border-top: 1px solid #e0e0e0;
        }
        .chatbot-input {
          flex: 1;
          border: 1px solid #d0d0d0;
          border-radius: 8px;
          padding: 8px 12px;
          font-size: 1em;
          outline: none;
        }
        .chatbot-send {
          background: #2d7ff9;
          color: #fff;
          border: none;
          border-radius: 8px;
          margin-left: 8px;
          padding: 0 18px;
          font-size: 1em;
          cursor: pointer;
          transition: background 0.2s;
        }
        .chatbot-send:disabled {
          background: #b0c8f9;
          cursor: not-allowed;
        }
        .chatbot-loader {
          text-align: center;
          margin: 8px 0;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 24px;
        }
        .chatbot-thinking {
          display: inline-block;
          width: 40px;
          height: 16px;
        }
        .chatbot-thinking span {
          display: inline-block;
          width: 8px;
          height: 8px;
          margin: 0 2px;
          background: #2d7ff9;
          border-radius: 50%;
          opacity: 0.5;
          animation: thinking-bounce 1s infinite;
        }
        .chatbot-thinking span:nth-child(2) { animation-delay: 0.2s; }
        .chatbot-thinking span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes thinking-bounce {
          0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
          40% { transform: scale(1.2); opacity: 1; }
        }
      `;this.shadowRoot.innerHTML=`
        <style>${t}</style>
        <div>
          <div class="chatbot-overlay"></div>
          <div class="chatbot-bubble" title="Abrir chat" tabindex="0">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2d7ff9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 15s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></svg>
          </div>
          ${this.isOpen?`
            <div class="chatbot-window${this._justOpened?" pop":""}">
              <div class="chatbot-header">
                <span>${this.title}</span>
                <div>
                  <button class="chatbot-header-btn" title="Nueva conversaci\xc3\xb3n">\xe2Å¸\xb3</button>
                  <button class="chatbot-close" title="Cerrar">
                    <svg viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
              </div>
              <div class="chatbot-messages">
                ${this.messages.map(t=>`<div class="chatbot-msg ${t.from}">${t.text}</div>`).join("")}
                ${this.loading?'<div class="chatbot-loader"><span class="chatbot-thinking"><span></span><span></span><span></span></span></div>':""}
              </div>
              <form class="chatbot-input-area">
                <input class="chatbot-input" type="text" placeholder="Escribe tu mensaje..." autocomplete="off" ${this.loading?"disabled":""} />
                <button class="chatbot-send" type="submit" ${this.loading?"disabled":""}>Enviar</button>
              </form>
            </div>
          `:""}
        </div>
      `;let e=this.shadowRoot.querySelector(".chatbot-bubble");e&&(e.onclick=()=>this.toggleChat());let s=this.shadowRoot.querySelector(".chatbot-close");s&&(s.onclick=()=>this.toggleChat());let o=this.shadowRoot.querySelector("form");o&&(o.onsubmit=t=>this.sendMessage(t));let i=this.shadowRoot.querySelector(".chatbot-header-btn");i&&(i.onclick=()=>this.newConversation());let a=this.shadowRoot.querySelector(".chatbot-overlay");a&&(a.onclick=()=>{this.isOpen&&this.toggleChat()}),this._justOpened=!1}}customElements.define("ai-chatbot",AIChatbot);
